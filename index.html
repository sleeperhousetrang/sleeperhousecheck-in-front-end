<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper House - Self Check-In</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles.css" type="text/css">
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="max-w-lg mx-auto my-10 bg-white p-8 rounded-lg shadow-md">
        <div class="flex justify-end space-x-4">
            <button onclick="changeLanguage('en')" class="px-4 py-2 bg-red-700 text-white rounded">üá¨üáß EN</button>
            <button onclick="changeLanguage('th')" class="px-4 py-2 bg-red-700 text-white rounded">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
        </div>
        <div class="flex justify-center mb-6">
            <img src="image.png" alt="Sleeper House Logo" class="h-48">
        </div>

        <h2 class="text-2xl font-bold text-red-700 mb-4 text-center" data-lang="en">Guest Check-In Form</h2>
        <h2 class="text-2xl font-bold text-red-700 mb-4 text-center hidden" data-lang="th">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</h2>

        <form id="checkin-form" class="space-y-4">
            <div>
                <label class="block font-semibold" data-lang="en">Name</label>
                <label class="block font-semibold hidden" data-lang="th">‡∏ä‡∏∑‡πà‡∏≠</label>
                <input name="name" type="text" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Email</label>
                <label class="block font-semibold hidden" data-lang="th">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input name="email" type="email" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Phone / Contact Number</label>
                <label class="block font-semibold hidden" data-lang="th">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå / ‡πÑ‡∏•‡∏ô‡πå / ‡∏ß‡∏µ‡πÅ‡∏ä‡∏ó</label>
                <input name="contact_number" type="text" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Number of Guests</label>
                <label class="block font-semibold hidden" data-lang="th">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Ç‡∏Å</label>
                <input name="number_of_guests" type="number" value="1" min="1" max="20" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Dates of Stay</label>
                <label class="block font-semibold hidden" data-lang="th">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
                <input id="stay_start_date" name="stay_start_date" type="date" class="p-2 border rounded">
                --
                <input id="stay_end_date" name="stay_end_date" type="date" class="p-2 border rounded">
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Expected Check-Out Time</label>
                <label class="block font-semibold hidden" data-lang="th">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                <label class="block" data-lang="en">Check-out time is from 7:30AM to 11:00AM</label>
                <select class="p-2 border rounded" name="expected_checkout_time" id="expected_checkout_time">
                    <option value=""></option>
                    <option value="7:30 AM">7:30 AM</option>
                    <option value="7:45 AM">7:45 AM</option>
                    <option value="8:00 AM">8:00 AM</option>
                    <option value="8:15 AM">8:15 AM</option>
                    <option value="8:30 AM">8:30 AM</option>
                    <option value="8:45 AM">8:45 AM</option>
                    <option value="9:00 AM">9:00 AM</option>
                    <option value="9:15 AM">9:15 AM</option>
                    <option value="9:30 AM">9:30 AM</option>
                    <option value="9:45 AM">9:45 AM</option>
                    <option value="10:00 AM">10:00 AM</option>
                    <option value="10:15 AM">10:15 AM</option>
                    <option value="10:30 AM">10:30 AM</option>
                    <option value="10:45 AM">10:45 AM</option>
                    <option value="11:00 AM">11:00 AM</option>
                  </select>
            </div>
            <div>
                <label class="block font-semibold" data-lang="en">Upload Thai ID / Passport</label>
                <label class="block" data-lang="en">Please upload IDs for each staying guest.</label>
                <label class="block font-semibold hidden" data-lang="th">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô / ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô</label>
                <label class="block" data-lang="en"></label>
            </div>
            <div class="dropzone mt-4 border-dashed border-2 p-4" id="file-upload"></div>

            <p class="text-sm text-gray-700 mt-4" data-lang="en">
                Sleeper House will not be responsible for any valuables left by guests in rooms or public areas including vehicles. Please do not leave important personal belongings or valuables items in the guest room or public areas.  Any guests causing damage to items belong to the property will be charged accordingly. <br /><br />  Each room has a safe deposit box. The dorm room has lockers for each bed (lock must be self-provided). Extra guests will be charged 250baht/person/night.
            </p>
            <p class="text-sm text-gray-700 mt-4" data-lang="en">
                Smoking in the room is prohibited. Violators will be fined THB2,000 for smoking inside a room.
                Durians are also prohibited.
            </p>
            <p class="text-sm text-gray-700 mt-4 hidden" data-lang="th">
                ‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡∏´‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏≥‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ ‡πÅ‡∏Ç‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏Ç‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô ‡∏Ñ‡∏¥‡∏î‡∏ó‡πà‡∏≤‡∏ô‡∏•‡∏∞ 250 ‡∏ö‡∏≤‡∏ó‡∏ï‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô
            </p>
            <button id="submit-btn" type="submit" class="relative flex items-center justify-center bg-red-700 text-white px-4 py-2 rounded w-full" onclick="submitForm(event)">
                <svg id="spinner" class="hidden absolute left-4 w-6 h-6 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="button-text" data-lang="en">Submit</span>
                <span id="button-text" class="hidden" data-lang="th">‡∏¢‡∏∑‡πà‡∏ô</span>
            </button>
        </form>
        <div id="submit_success" class="hidden text-center font-bold">
            <i class="fa-duotone fa-regular fa-calendar-check text-green-700 text-8xl"></i><br><br>
            <p class="font-bold text-red-700 text-2xl" data-lang="en">Thank you!</p>
            <p class="hidden font-bold text-red-700 text-2xl" data-lang="th">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞!</p>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", (event) => {
            let today = new Date();
            let tomorrow = new Date(today.getTime() + 86400000);
            document.getElementById("stay_start_date").valueAsDate = today;
            document.getElementById("stay_end_date").valueAsDate = tomorrow;
        });

        // Global variables for Dropzone management
        Dropzone.autoDiscover = false;
        let uploadedFiles = []; // Stores successfully uploaded file names from the server response
        let dropzoneInstance = null; // Renamed to avoid conflict with `dropzone`
        let currentLanguage = "en";
        const currentTimestamp = Date.now();
        const backendUrl = "https://phm4pqay5epdxoo7up3fxwkqya0rgsfd.lambda-url.us-east-2.on.aws";
        // const backendUrl = "http://localhost:8000"

        function enableSubmitButton() {
            document.getElementById("spinner").classList.add('hidden');
            document.getElementById("submit-btn").disabled = false;
            document.getElementById("submit-btn").classList.add('bg-red-700');
            document.getElementById("submit-btn").classList.remove('bg-gray-500');
        }

        function disableSubmitButton() {
            document.getElementById("spinner").classList.remove('hidden');
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("submit-btn").classList.add('bg-gray-500');
            document.getElementById("submit-btn").classList.remove('bg-red-700');
        }

        function changeLanguage(lang) {
            document.querySelectorAll('[data-lang]').forEach(el => {
                el.classList.toggle('hidden', el.getAttribute('data-lang') !== lang);
            });
            currentLanguage = lang;

            // Update Dropzone messages directly on the instance
            if (dropzoneInstance) {
                dropzoneInstance.options.dictDefaultMessage = currentLanguage === "th" ?
                    '<i class="fa-solid fa-upload text-gray-500 p-2 text-4xl"></i><br>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà' :
                    '<i class="fa-solid fa-upload text-gray-500 p-2 text-4xl"></i><br>Drop files here to upload';
                dropzoneInstance.options.dictCancelUpload = currentLanguage === "th" ?
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' :
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> Cancel';
                dropzoneInstance.options.dictRemoveFile = currentLanguage === "th" ?
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå' :
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> Remove file';

                // Manually update the default message element if it exists
                const defaultMessageElement = dropzoneInstance.element.querySelector('.dz-message');
                if (defaultMessageElement) {
                     defaultMessageElement.innerHTML = dropzoneInstance.options.dictDefaultMessage;
                }
            }
        }

        function submitForm(event) {
            event.preventDefault();
            let isValid = true;
            let validEmail = false;

            document.querySelectorAll('#checkin-form input').forEach(input => {
                if (input.name == "email") {
                    validEmail = input.checkValidity() && input.value != ""
                    if (!validEmail) {
                        input.classList.add('border-red-500');
                        isValid = false;
                    }
                }
                if (!input.value && input.type !== 'file') { // Exclude file input from general validation
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                }
            });

            let expectedCheckoutTime = document.getElementById("expected_checkout_time")
            if (expectedCheckoutTime.value == "") {
                expectedCheckoutTime.classList.add('border-red-500');
                isValid = false
            } else {
                expectedCheckoutTime.classList.remove('border-red-500');
            }

            // Check if uploads are still in progress
            if (dropzoneInstance && (dropzoneInstance.getUploadingFiles().length > 0 || dropzoneInstance.getQueuedFiles().length > 0)) {
                let errorMessageEnglish = 'Please wait for all uploads to complete before submitting.';
                let errorMessageThai = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°';
                alert(currentLanguage == "th" ? errorMessageThai : errorMessageEnglish);
                return;
            }

            let actualUploadedFilesCount = dropzoneInstance.files.filter(file => file.status === Dropzone.SUCCESS).length;
            if (actualUploadedFilesCount < 1) { // Or if you require a minimum number of files
                document.getElementById('file-upload').classList.add('border-red-500');
                isValid = false;
            } else {
                document.getElementById('file-upload').classList.remove('border-red-500');
            }

            if (!isValid) {
                let errorMessageEnglish = 'Please complete all fields.';
                let errorMessageThai = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
                if (!validEmail) {
                    errorMessageEnglish += ' Entered email is invalid.'
                    errorMessageThai += ' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                }
                if (dropzoneInstance.files.length < 1) {
                    // No files at all in the dropzone
                    errorMessageEnglish += ' Please upload at least one file.';
                    errorMessageThai += ' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå';
                } else if (actualUploadedFilesCount < 1) {
                    // Files exist, but none have uploaded successfully
                    errorMessageEnglish += ' Please wait for your file(s) to finish uploading successfully.';
                    errorMessageThai += ' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô';
                }
                alert(currentLanguage == "th" ? errorMessageThai : errorMessageEnglish);
                return;
            }

            disableSubmitButton();
            let formData = Object.fromEntries(new FormData(document.getElementById("checkin-form")).entries());

            // Add uploaded files to the form data
            formData.uploadedFiles = uploadedFiles;

            fetch(`${backendUrl}/formSubmit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("checkin-form").classList.add("hidden");
                    document.getElementById("submit_success").classList.remove("hidden");
                } else {
                    enableSubmitButton();
                    alert('There was an error submitting your check-in. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred. Please try again later.');
            });
        }

        function guidGenerator() {
            let S4 = function() {
              return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
            };
            return S4()+S4();
        }

        function initializeDropzone() {
            // Check if Dropzone instance already exists to prevent re-initialization
            if (dropzoneInstance) {
                return;
            }

            dropzoneInstance = new Dropzone("#file-upload", {
                url: `${backendUrl}/b2PresignedUrl`, // This will be replaced dynamically
                method: "POST",
                sending: function(file, xhr) {
                    var _send = xhr.send;
                    xhr.send = function() {
                        _send.call(xhr, file);
                    };
                },
                renameFile: function(file) {
                    const currentDate = new Date();
                    let formattedDate = currentDate.toISOString().split('T')[0];
                    return `${formattedDate}/${currentTimestamp}/p${guidGenerator()}-${file.name}`;
                },
                maxFilesize: 20, // 20 MB limit
                paramName: "file",
                parallelUploads: 10, // Allow multiple files
                uploadMultiple: false,
                chunking: false,
                autoProcessQueue: false,
                addRemoveLinks: true,
                dictDefaultMessage: currentLanguage === "th" ?
                    '<i class="fa-solid fa-upload text-gray-500 p-2 text-4xl"></i><br>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà' :
                    '<i class="fa-solid fa-upload text-gray-500 p-2 text-4xl"></i><br>Drop files here to upload',
                dictCancelUpload: currentLanguage === "th" ?
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' :
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> Cancel',
                dictRemoveFile: currentLanguage === "th" ?
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå' :
                    '<i class="fa-solid fa-circle-xmark text-red-700 text-2xl"></i> Remove file',

                init: function () {
                    let dz = this; // Capture 'this' for use in callbacks

                    // Re-add existing uploaded files visually when initializing
                    uploadedFiles.forEach(fileName => {
                        let mockFile = {
                            name: fileName.split('/').pop(), // Get original file name from path
                            size: 0, // Size is not available, but required by Dropzone
                            status: Dropzone.SUCCESS,
                            accepted: true,
                            upload: {
                                filename: fileName // Store the full path for internal use
                            }
                        };
                        dz.files.push(mockFile);
                        dz.emit("addedfile", mockFile);
                        dz.emit("complete", mockFile);
                        dz.emit("thumbnail", mockFile, null); // No thumbnail for re-added files unless stored
                    });

                    this.on("addedfile", async function (file) {
                        disableSubmitButton();
                        try {
                            const response = await fetch(`${backendUrl}/b2PresignedUrl`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();
                            file.b2UploadUrl = data.uploadUrl;
                            file.b2AuthToken = data.authorizationToken;
                            file.b2FilePath = data.filePath; // Store file path from server response
                            this.processFile(file); // Process the file once URL is obtained
                        } catch (error) {
                            console.error("Error fetching presigned URL:", error);
                            // Emit error and remove file if URL fetch fails
                            this.emit("error", file, "Error fetching upload URL.");
                            this.removeFile(file); // Manually remove the file from Dropzone display
                            // Ensure button is re-enabled if no other uploads are pending
                            if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                                enableSubmitButton();
                            }
                        }
                    });

                    this.on("queuecomplete", function(){
                        // Enable submit button only if no uploads are in progress
                        if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                            enableSubmitButton();
                        }
                    });

                    this.on("sending", function (file, xhr, formData) {
                        xhr.open("POST", file.b2UploadUrl, true);
                        xhr.setRequestHeader("Authorization", file.b2AuthToken);
                        xhr.setRequestHeader("X-Bz-File-Name", encodeURIComponent(file.upload.filename));
                        xhr.setRequestHeader("Content-Type", file.type);
                        xhr.setRequestHeader("X-Bz-Content-Sha1", "do_not_verify");

                        // Display progress bar
                        const progressBar = file.previewElement.querySelector(".dz-progress");
                        if (progressBar) { // Check if element exists before accessing style
                            progressBar.style.display = "block";
                        }
                    });

                    this.on("uploadprogress", function (file, progress, bytesSent) {
                        // Update the progress bar
                        let progressBar = file.previewElement.querySelector(".dz-upload");
                        if (progressBar) { // Ensure progressBar exists
                            progressBar.style.width = progress + "%";
                            progressBar.textContent = Math.round(progress) + "%";
                        }
                    });

                    this.on("success", function (file, response) {
                        // Store uploaded file path as returned by the backend
                        if (response && response.fileName) {
                            uploadedFiles.push(response.fileName);
                        } else {
                            // Fallback to client-generated filename if backend doesn't return one
                            uploadedFiles.push(file.upload.filename);
                        }
                        console.log("uploaded files:", uploadedFiles);
                        const successMark = file.previewElement.querySelector(".dz-success-mark");
                        if (successMark) {
                            successMark.style.opacity = "1";
                        }

                        // Re-enable submit button if no more files are uploading or queued
                        if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                            enableSubmitButton();
                        }
                    });

                    this.on("removedfile", function (file) {
                        // Use the correct filename (from backend response if available, else client-generated)
                        // Note: If you have re-added mock files, their 'upload.filename' will be the full path.
                        // Ensure consistency here.
                        const fileNameToRemove = file.upload.filename || file.name; // Prioritize full path, then original name

                        const index = uploadedFiles.indexOf(fileNameToRemove);
                        if (index > -1) {
                            uploadedFiles.splice(index, 1);
                        }
                        console.log("removed file; uploaded files", uploadedFiles);

                        // Re-enable submit button if no more files are uploading or queued
                        if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                            enableSubmitButton();
                        }
                    });

                    this.on("error", function (file, errorMessage) {
                        console.error("Upload error", file.name, errorMessage);
                        let errorMsgEnglish = `Failed to upload ${file.name}. Please try uploading again. If the problem persists, please check your internet connection and try again.`;
                        let errorMsgThai = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${file.name} ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;

                        alert(currentLanguage == "th" ? errorMsgThai : errorMsgEnglish);

                        // Re-enable submit button if no more files are uploading or queued
                        if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                            enableSubmitButton();
                        }
                    });
                }
            });
        }

        // Initialize Dropzone when the DOM is ready
        document.addEventListener("DOMContentLoaded", initializeDropzone);
      </script>
</body>
</html>
